<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layouts/default}">

<head>
    <title>Monitor - Bina Cloud</title>
    <th:block layout:fragment="css">
        <style>
            .event-list {
                max-height: 600px;
                overflow-y: auto;
            }

            .event-item {
                padding: 1rem;
                border-bottom: 1px solid var(--border-color);
                transition: background-color 0.2s;
            }

            .event-item:hover {
                background-color: var(--hover-bg);
            }

            .event-item:last-child {
                border-bottom: none;
            }

            .event-title {
                font-weight: 600;
                margin-bottom: 0.5rem;
            }

            .event-meta {
                font-size: 0.875rem;
                color: var(--text-muted);
                margin-bottom: 0.5rem;
            }

            .event-data {
                font-size: 0.875rem;
                background-color: var(--bg-light);
                padding: 0.5rem;
                border-radius: 0.25rem;
                margin-top: 0.5rem;
            }

            .notification {
                position: fixed;
                top: 1rem;
                right: 1rem;
                z-index: 1000;
                min-width: 300px;
                max-width: 400px;
                animation: slideIn 0.3s ease-out;
            }

            .connection-status {
                position: fixed;
                bottom: 1rem;
                right: 1rem;
                z-index: 1000;
                padding: 0.5rem 1rem;
                border-radius: 0.25rem;
                animation: fadeIn 0.3s ease-out;
            }

            .connection-status.connected {
                background-color: var(--success-color);
                color: white;
            }

            .connection-status.disconnected {
                background-color: var(--danger-color);
                color: white;
            }

            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                }

                to {
                    transform: translateX(0);
                }
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                }

                to {
                    opacity: 1;
                }
            }
        </style>
    </th:block>
</head>

<body>
    <main layout:fragment="content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">Monitor em Tempo Real</h1>
            <div>
                <span class="badge bg-primary me-2" id="eventCount">0 eventos</span>
                <button class="btn btn-primary" onclick="clearEvents()">
                    <i class="fas fa-trash"></i> Limpar
                </button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Eventos em Tempo Real</h5>
            </div>
            <div class="card-body p-0">
                <div class="event-list" id="eventList">
                    <div class="text-center py-5">
                        <i class="fas fa-broadcast-tower fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Aguardando eventos...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <th:block layout:fragment="scripts">
        <script>
            let ws;
            let eventCount = 0;
            const maxEvents = 100;
            const eventList = document.getElementById('eventList');
            const eventCountBadge = document.getElementById('eventCount');

            function connect() {
                ws = new WebSocket('ws://' + window.location.host + '/ws/events');

                ws.onopen = () => {
                    showConnectionStatus(true);
                };

                ws.onclose = () => {
                    showConnectionStatus(false);
                    setTimeout(connect, 5000);
                };

                ws.onmessage = (event) => {
                    const evento = JSON.parse(event.data);
                    addEvent(evento);
                };
            }

            function addEvent(evento) {
                eventCount++;
                eventCountBadge.textContent = eventCount + ' eventos';

                const eventElement = document.createElement('div');
                eventElement.className = 'event-item';
                eventElement.innerHTML = `
                    <div class="event-title">${evento.description}</div>
                    <div class="event-meta">
                        <span class="badge ${evento.eventType === 'ALERTA' ? 'bg-danger' : 'bg-info'}">${evento.eventType}</span>
                        <span class="ms-2">${evento.deviceId}</span>
                        <span class="ms-2">${evento.phoneNumber}</span>
                        <span class="ms-2">${new Date().toLocaleString()}</span>
                    </div>
                    ${evento.additionalData ? `<div class="event-data">${evento.additionalData}</div>` : ''}
                `;

                eventList.insertBefore(eventElement, eventList.firstChild);

                if (eventCount > maxEvents) {
                    eventList.removeChild(eventList.lastChild);
                    eventCount--;
                    eventCountBadge.textContent = eventCount + ' eventos';
                }

                showNotification(evento);
            }

            function showNotification(evento) {
                const notification = document.createElement('div');
                notification.className = 'notification alert alert-info alert-dismissible fade show';
                notification.innerHTML = `
                    <i class="fas fa-bell me-2"></i>
                    <strong>${evento.description}</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 5000);
            }

            function showConnectionStatus(connected) {
                let status = document.getElementById('connectionStatus');
                if (!status) {
                    status = document.createElement('div');
                    status.id = 'connectionStatus';
                    status.className = 'connection-status';
                    document.body.appendChild(status);
                }

                status.className = `connection-status ${connected ? 'connected' : 'disconnected'}`;
                status.innerHTML = `<i class="fas ${connected ? 'fa-check-circle' : 'fa-times-circle'} me-2"></i>
                    ${connected ? 'Conectado' : 'Desconectado'}`;
            }

            function clearEvents() {
                eventList.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-broadcast-tower fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Aguardando eventos...</p>
                    </div>
                `;
                eventCount = 0;
                eventCountBadge.textContent = '0 eventos';
            }

            connect();
        </script>
    </th:block>
</body>

</html>